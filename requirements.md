# QR码单向通信项目需求分析

## 1. 背景与目标
- 需求：通过一台电脑显示器播放二维码序列，另一设备用摄像头实时或离线（录像文件）解析，实现文件/日志/任意二进制的单向传输。
- 目标：高可靠性（长时间录像仍可完整还原），可配置的传输速率（含同时显示多个二维码），低第三方依赖，Python 实现。
- 成功判据：在典型场景下（1080p 显示器、30fps 摄像头、2×2 网格）传输指定大小文件时，误码率可控（完整校验通过），中途遮挡/抖动可自恢复或容错。

## 2. 范围与场景
- 发送端：PC 显示器展示二维码序列；支持窗口化/全屏。
- 接收端：摄像头实时流或视频文件；可脱机处理。
- 数据类型：单文件、多文件打包（含日志）、标准输入流、任意二进制。
- 不在范围：反向控制/握手（保持单向）；跨网络同步。

## 3. 技术与依赖
- 语言/版本：Python 3.10+。
- 第三方库（尽量少）：
  - `opencv-python`：视频采集、帧解码、`cv2.QRCodeDetector` 解析。
  - `numpy`：图像矩阵处理。
  - `segno` 或 `qrcode`：生成二维码（纯 Python，减少外部依赖）。
  - 可选：`reedsolo`（或等效 RS/FEC 库）用于外层前向纠错；若需加密可选 `cryptography`（默认关闭以减依赖）。
- 内置库：`zlib`/`lzma` 压缩、`hashlib` 摘要、`struct`/`json` 序列化、`argparse` 配置。

## 4. 目标指标
- 可靠性：单段录像完整恢复，文件级 SHA256 校验通过；在 1–5% 帧丢失、轻微模糊情况下仍可恢复（依赖外层冗余/FEC）。
- 吞吐：可配置帧率（建议 5–15fps），可配置网格列行（1×1 至 3×3 视硬件而定）；在 2×2、10fps、QR 版本 10–15、ECC 高级别下可达数十 KB/s 量级。
- 延迟：发送端启动后接收端在数秒内完成同步（基于会话头+周期性索引帧）。
- 兼容性：1080p 显示+720p/1080p 摄像头为主；不同亮度/对比度可配置。

## 5. 功能需求
### 5.1 数据打包与会话
- 支持输入：单文件、多文件目录打包（ZIP/TAR）、stdin。
- 生成会话描述（JSON/CBOR）：会话 ID、总字节数、文件列表（名称、大小、mtime、权限可选）、整体 SHA256、块大小、FEC 参数、压缩/加密标记。
- 可选压缩：对打包数据整体或块级压缩（zlib 级别可调）。
- 可选加密：对会话负载进行对称加密（若启用则记录算法与盐/IV；密钥由用户外部分发）。

### 5.2 分片与纠错
- 将数据拆分为固定大小块（payload size 依据二维码容量动态计算）；每块含序号、会话 ID、CRC32/16。
- 生成“超块”（super-block）：例如每 N 数据块 + M 冗余块（RS 编码），可配置 N/M 以适应场景；冗余块中含覆盖的块范围与编码参数。
- 每个超块可重复播发若干轮，提升恢复概率；支持自适应重复次数（依据块完成率或用户阈值）。

### 5.3 帧格式
- 帧类型：`SESSION_HEADER`（多次重复）、`DATA`、`FEC`、`HEARTBEAT/INDEX`（周期性索引便于重同步）。
- 每帧字段：版本、会话 ID、帧类型、超块 ID、块序号/范围、总块数、帧内片段序号、校验（CRC）、可选时间戳。
- 多二维码布局：同一帧（屏幕时刻）内展示 K 个独立 QR，每个承载一个块；布局元数据（K、顺序）在头部和索引帧中声明。
- 采用 QR 高纠错等级（建议 H），版本根据 payload 长度和屏幕分辨率自动或手动选择。

### 5.4 发送端功能
- CLI 子命令：`send`。
- 参数：输入路径/stdin、输出分辨率（默认全屏检测）、网格行列、每二维码目标版本/ECC、帧率、超块大小与冗余率、压缩/加密开关、重复轮次、前景/背景颜色、边距。
- 显示：固定网格布局，留出静态边框/定位色块以提高摄像头识别；可选在每帧叠加进度/状态文字。
- 进度：实时显示已播块数、完成百分比、预计剩余时长。
- 控制：键盘中断安全停止（可选择保存继续点以便下次从指定超块继续）。

### 5.5 接收端功能
- CLI 子命令：`receive`。
- 输入源：摄像头索引/分辨率/FPS，或视频文件路径。
- 预处理：自动/可调的曝光、对比度、锐化；畸变矫正/裁剪（可选，利用定位色块）。
- 解码：逐帧检测网格位置；对每个格子调用 `cv2.QRCodeDetector`；若失败尝试自适应阈值。
- 重组：依据会话 ID、超块/块序号存储；完成一个超块后利用 FEC 还原；重复/乱序/重复帧自动去重。
- 校验：块级 CRC，超块 RS 校验失败则保留未恢复列表；全会话 SHA256 最终校验并输出结果。
- 状态与日志：实时显示完成率、缺失块数、当前超块恢复率、错误统计；输出到日志文件。
- 输出：还原为原始文件/目录；校验通过前不覆盖已有文件，可输出到临时目录后原子替换。

### 5.6 容错与稳定性
- 多重校验：QR 内置 ECC + 块级 CRC + 会话 SHA256。
- 冗余：超块 FEC、帧重复播发、周期性 SESSION_HEADER/INDEX 便于中途加入/重同步。
- 空转检测：长时间无法识别帧时提示调整光线/对焦；可自动降低帧率或提示重播。
- 同步：每隔 T 秒插入索引帧，包含当前超块范围与布局信息，便于解码器对齐。

## 6. 配置与可扩展性
- 配置方式：CLI 参数 + 可选 YAML/JSON 配置文件（包含默认网格、帧率、FEC 参数、颜色主题）。
- 模块化设计：生成器（打包/分片）、编码器（QR 渲染）、播放器（显示定时）、采集器（视频流）、解码器（QR 解析）、重组器（FEC/校验）、CLI 层。
- 日志：标准输出 + 文件；日志级别 DEBUG/INFO/WARN/ERROR，可开启性能计数（解析耗时、成功率）。

## 7. 性能与物理考量
- 网格与尺寸：自动计算单 QR 尺寸与边距，保证摄像头在给定距离下可分辨（根据屏幕分辨率和摄像头 FOV 提供建议）。
- 帧率与快门：建议发送端帧率与摄像头 FPS 整除或接近；默认 10fps，避免运动模糊。
- 颜色/对比度：默认黑白；可选深色背景+浅色前景，需保持高对比。
- 资源占用：目标在普通笔记本 CPU 上实时渲染 2×2 网格且解码不掉帧。

## 8. 安全与隐私
- 数据保密：默认明文；可选对称加密（AES-GCM）；密钥由用户线下提供。
- 完整性：强制会话 SHA256；校验失败即提示。
- 日志隐私：可选择匿名化（不记录文件名），或日志内仅记录会话 ID。

## 9. 测试与验证
- 单元测试：分片/组装、CRC 校验、FEC 编解码、会话头解析、配置解析。
- 属性测试：随机数据通过管道往返验证完整性。
- 集成测试：生成短视频流（OpenCV 合成）、多网格、多帧率，验证解码成功率和性能。
- 端到端：实际摄像头录制固定环境（弱光/抖动/遮挡）并验证恢复率；大文件压力测试。

## 10. 交付物
- CLI 工具（send/receive）及模块化库接口。
- 示例配置文件、示例数据、使用说明（含参数建议、故障排查）。
- 基础测试用例与自动化脚本（可选 GitHub Actions / 本地脚本）。
